<title>חנות הפרחים של שמחה</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

<style>
  /* Remove the navbar's default margin-bottom and rounded borders */
  .navbar {
    margin-bottom: 0;
    border-radius: 0;
  }

  /* Set height of the grid so .sidenav can be 100% (adjust as needed) */
  .row.content {
    height: 450px
  }

  /* Set gray background color and 100% height */
  .sidenav {
    padding-top: 20px;
    background-color: #f1f1f1;
    height: 100%;
  }

  /* Set black background color, white text and some padding */
  footer {
    background-color: #555;
    color: white;
    padding: 15px;
  }

  /* On small screens, set height to 'auto' for sidenav and grid */
  @media screen and (max-width: 767px) {
    .sidenav {
      height: auto;
      padding: 15px;
    }

    .row.content {
      height: auto;
    }
  }

  .open-button {
    background-color: #555;
    color: white;
    padding: 16px 20px;
    border: none;
    cursor: pointer;
    opacity: 0.8;
    position: fixed;
    bottom: 23px;
    right: 28px;
    width: 280px;
  }

  /* The popup form - hidden by default */
  .form-popup {
    display: none;
    position: fixed;
    top: 55px;
    right: 15px;
    border: 3px solid #f1f1f1;
    z-index: 9;
  }

  .new-user-form-popup {
    display: block;
    position: fixed;
    top: 120px;
    margin: auto;

    border: 3px solid #f1f1f1;
    z-index: 9;
  }

  /* Add styles to the form container */
  .form-container {
    max-width: 300px;
    padding: 10px;
    background-color: white;
  }

  .new-user-form-container {
    max-width: 800px;
  }

  /* Full-width input fields */
  .form-container input[type=text],
  .form-container input[type=password],
  .form-container input[type=tel],
  .form-container select,
  .form-container input[type=email] {
    width: 95%;
    padding: 15px;
    margin: 5px 0 22px 0;
    border: none;
    background: #f1f1f1;
  }

  /* When the inputs get focus, do something */
  .form-container input[type=text]:focus,
  .form-container input[type=password]:focus,
  .form-container input[type=tel]:focus,
  .form-container select:focus,
  .form-container input[type=email]:focus {
    background-color: #ddd;
    outline: none;
  }

  /* Set a style for the submit/login button */
  .form-container .btn {
    background-color: #4CAF50;
    color: white;
    padding: 16px 20px;
    border: none;
    cursor: pointer;
    width: 100%;
    margin-bottom: 10px;
    opacity: 0.8;
  }

  /* Add some hover effects to buttons */
  .form-container .btn:hover,
  .open-button:hover {
    opacity: 1;
  }
</style>

<script>
  $(document).ready(function () {
    $(window).on("load", async function () {
      $.ajax({
        url: "aboutUs.ejs", success: function (result) {
          $("#main").html(result);
        }
      });
      if (user) {
        user = user.replace(/&#34;/g, '"');
        user = JSON.parse(user);
        setLoggedinScreen(user.type, user.name);
      }
      console.log("href: ", window.location.hash);
      switch (window.location.hash) {
        case '#contact':
          loadContact();
          break;
        case '#about':
          loadAbout();
          break;
        case '#users':
          loadUsers();
          break;
        case '#stores':
          loadStores();
          break;
        case '#catalog':
          loadCatalog();
          break;
        default:
          break;
      }
      console.log('user: ' + user);
    });

    $('#header').on("load", async function () {
      let res = await fetch('/', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
          Accept: 'application/json'
        },
        responseType: 'json'
      });
    });

    $('#root').mouseup(function (event) {
      let notLoggedIn = $('#notLoggedIn');
      let loginForm = $('#loginFormDiv');
      if (!notLoggedIn.has(event.target).length > 0) {
        if (!loginForm.has(event.target).length > 0) {
          loginForm.css("display", "none");
        }
      }
    });

    $('#login').on('click', function () {
      let loginForm = $('#loginFormDiv');
      if (loginForm.css("display") === "block") {
        $('#loginFormDiv').css("display", "none");
      } else {
        $('#loginFormDiv').css("display", "block");
      }
    });

    $('#logbtn').on('click', async function (event) {
      console.log("Enter login func");
      let userMail = $('#email').val();
      let userPassword = $('#psw').val();
      let data = { "email": userMail, "password": userPassword };
      try {
        let res = await fetch('/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data),
        });
        let detailes = await res.json();
        let status = await res.status;
        if (status === 200) {
          console.log("abc");
          let user = detailes.Myuser;
          console.log("post user", user);
          var newurl = window.location.pathname + '?user=' + user.email;
          window.history.pushState({ path: newurl }, '', newurl);
          setLoggedinScreen(user.type, user.name);
        } else if (status === 401) {
          alert(detailes.msg)
        }
        console.log(detailes);
      } catch (e) {
        console.log(e);
        console.log("Enter login catch");
      }
    });

    $('#aboutUs').on('click', function () {
      loadAbout();
    });

    function loadAbout() {
      $.ajax({
        url: "aboutUs.ejs", success: function (result) {
          $("#main").html(result);
        }
      });
    }

    $('#contactUs').on('click', function () {
      loadContact();
    });

    function loadContact() {
      $.ajax({
        url: "simcha.ejs", success: function (result) {
          $("#main").html(result);
        }
      });
    }

    $('#flowersCatalog').on('click', function () {
      loadCatalog();
    });

    function loadCatalog() {
      $.ajax({
        type: "GET",
        url: "/flowers",
        success: function (res) {
          console.log("res: ", res);
          $("#main").html(res);
        }
      });
    }

    $('#manageStores').on('click', function () {
      loadStores();
    });

    function loadStores() {
      $.ajax({
        type: "GET",
        url: "/stores",
        success: function (res) {
          console.log("res: ", res);
          $("#main").html(res);
        }
      });
    }

    $('#manageUsers').on('click', function () {
      loadUsers();
    });

    function loadUsers() {
      $.ajax({
        type: "GET",
        url: "/users",
        success: function (res) {
          console.log("res: ", res);
          $("#main").html(res);
        }
      });
    }

    $('#logOut').on('click', async function (event) {
      /* let mail = user.email;
      let data = { "emailToOut": mail };
      let res = await fetch('/logOut', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(data),
      });
      let status = await res.status;
      if (status === 200) { */
        var newurl = window.location.pathname;
        window.history.pushState({ path: newurl }, '', newurl);
        $('#notLoggedIn').css("display", "block");
        $('#loggedIn').css("display", "none");
        $('#helloUser').innerText = "";
        $('#flowersCatalog').css("display", "none");
        $('#manageUsers').css("display", "none");
        $('#manageStores').css("display", "none");
     // }
      loadAbout();
    });

    function setLoggedinScreen(type, name) {
      $('#loginFormDiv').css("display", "none");
      $('#loginForm').trigger('reset');
      $('#notLoggedIn').css("display", "none");
      $('#loggedIn').css("display", "block");
      $('#helloUser').html("Hello " + name);
      $('#flowersCatalog').css("display", "block");
      if (type === "Admin" || type === "officer") {
        $('#manageUsers').css("display", "block");
        $('#manageStores').css("display", "block");
      }
    }
  });
</script>